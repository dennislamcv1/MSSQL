-- [dbo] - Data Warehouse Schema
-- Assumes existence of OLTP database TechHealthDb with original tables

-- Dimension: Date
CREATE TABLE [dbo].[DimDate] (
    DateKey INT PRIMARY KEY, -- Format: YYYYMMDD
    Date DATE NOT NULL,
    Year INT NOT NULL,
    Quarter INT NOT NULL,
    Month INT NOT NULL,
    Day INT NOT NULL,
    WeekdayName VARCHAR(10) NOT NULL
);
GO

-- Dimension: Customer
CREATE TABLE [dbo].[DimCustomer] (
    CustomerKey INT IDENTITY(1,1) PRIMARY KEY,
    UserID VARCHAR(10) NOT NULL,
    Age INT,
    Gender CHAR(1),
    Occupation VARCHAR(100),
    IncomeBracket VARCHAR(20),
    SubscriptionType VARCHAR(50),
    City VARCHAR(100),
    State VARCHAR(50),
    Country VARCHAR(50)
);
GO

-- Dimension: Product
CREATE TABLE [dbo].[DimProduct] (
    ProductKey INT IDENTITY(1,1) PRIMARY KEY,
    ProductID VARCHAR(20) NOT NULL,
    ProductName VARCHAR(100),
    ProductCategory VARCHAR(50)
);
GO

-- Dimension: Device
CREATE TABLE [dbo].[DimDevice] (
    DeviceKey INT IDENTITY(1,1) PRIMARY KEY,
    DeviceID VARCHAR(10),
    DeviceType VARCHAR(100),
    FirmwareVersion VARCHAR(10),
    BatteryLifeDays DECIMAL(3,1),
    SyncFrequencyDaily INT,
    ActiveHoursDaily DECIMAL(3,1),
    SleepTrackingEnabled BIT,
    HeartRateMonitoringEnabled BIT,
    GPSEnabled BIT,
    NotificationEnabled BIT,
    DeviceStatus VARCHAR(50)
);
GO

-- Dimension: Coach
CREATE TABLE [dbo].[DimCoach] (
    CoachKey INT IDENTITY(1,1) PRIMARY KEY,
    CoachID VARCHAR(10),
    FirstName VARCHAR(50),
    LastName VARCHAR(50),
    Specialization VARCHAR(100),
    ExperienceYears INT,
    Certification VARCHAR(100),
    Region VARCHAR(50),
    ContactEmail VARCHAR(100)
);
GO


-- Fact Table: Sales
CREATE TABLE [dbo].[FactSales] (
    SaleID VARCHAR(10) PRIMARY KEY,
    CustomerKey INT,
    ProductKey INT,
    DateKey INT,
    UnitPrice DECIMAL(10,2),
    Quantity INT,
    DiscountApplied DECIMAL(5,2),
    TotalAmount DECIMAL(10,2),
    PaymentMethod VARCHAR(50),
    SubscriptionPlan VARCHAR(50),
    SalesChannel VARCHAR(50),
    Region VARCHAR(50),
    SalesRepID VARCHAR(10),
    FOREIGN KEY (CustomerKey) REFERENCES [dbo].[DimCustomer](CustomerKey),
    FOREIGN KEY (ProductKey) REFERENCES [dbo].[DimProduct](ProductKey),
    FOREIGN KEY (DateKey) REFERENCES [dbo].[DimDate](DateKey) ON DELETE SET NULL
);
GO

-- Fact Table: Health Metrics
CREATE TABLE [dbo].[FactHealthMetrics] (
    RecordID VARCHAR(10) PRIMARY KEY,
    CustomerKey INT,
    DateKey INT,
    AvgHeartRate INT,
    AvgRestingHeartRate INT,
    AvgDailySteps INT,
    AvgSleepHours DECIMAL(3,1),
    AvgDeepSleepHours DECIMAL(3,1),
    AvgDailyCalories INT,
    AvgExerciseMinutes INT,
    AvgStressLevel DECIMAL(3,1),
    AvgBloodOxygen DECIMAL(4,1),
    TotalActiveDays INT,
    WorkoutFrequency INT,
    AchievementRate DECIMAL(3,2),
    FOREIGN KEY (CustomerKey) REFERENCES [dbo].[DimCustomer](CustomerKey),
    FOREIGN KEY (DateKey) REFERENCES [dbo].[DimDate](DateKey)
);
GO

-- Fact Table: Service Tickets
CREATE TABLE [dbo].[FactServiceTickets] (
    TicketID VARCHAR(10) PRIMARY KEY,
    CustomerKey INT,
    DeviceKey INT,
    DateKey INT,
    TicketStatus VARCHAR(50),
    ResolutionDate DATE,
    IssueDescription VARCHAR(255),
    FOREIGN KEY (CustomerKey) REFERENCES [dbo].[DimCustomer](CustomerKey),
    FOREIGN KEY (DeviceKey) REFERENCES [dbo].[DimDevice](DeviceKey)
);
GO
